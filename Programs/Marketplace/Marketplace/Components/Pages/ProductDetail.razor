@page "/product/{ProductId:int}"
@using yyy.Services
@inject IProductService ProductService
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject UserService UserService
@rendermode InteractiveServer
<link href="css/product-detail.css" rel="stylesheet" />

<!-- Верхняя панель навигации -->
<nav class="top-nav">
    <div class="nav-container">
        <div class="nav-brand">VALUED</div>
        <ul class="nav-menu" style="margin-left: auto;">
            <li><a href="/" class="nav-link">Главная</a></li>
            @if (isAuthenticated)
            {
                <li><a href="/profile" class="nav-link">Профиль</a></li>
            }
            else
            {
                <li><a href="#" class="nav-link" @onclick="ShowLoginModal">Вход</a></li>
            }
            <li><a href="/cart" class="nav-link cart-link">Корзина (@GetCartItemsCount())</a></li>
        </ul>
    </div>
</nav>

<div class="product-detail-container">
    @if (product != null)
    {
        <div class="product-detail">
            <div class="product-image-section">
                <img src="@product.ImageUrl" class="product-image-large" alt="@product.Name" />
            </div>

            <div class="product-info-section">
                <h1 class="product-title">@product.Name</h1>
                <p class="product-description">@product.Description</p>
                <div class="product-price-large">@product.Price</div>

                <div class="product-actions">
                    @if (IsProductInCart(product.Id))
                    {
                        <button class="btn btn-in-cart" disabled>
                            В корзине
                        </button>
                    }
                    else
                    {
                        <button class="btn btn-cart" @onclick="() => AddToCart(product.Id)">
                            В корзину
                        </button>
                    }
                    <button class="btn btn-buy" @onclick="() => BuyNow(product.Id)">
                        Купить сейчас
                    </button>
                </div>

                <div class="product-features">
                    <h3>Характеристики</h3>
                    <ul>
                        <li>✅ Бесплатная доставка</li>
                        <li>✅ Гарантия качества</li>
                        <li>✅ Быстрая обработка заказа</li>
                    </ul>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="product-not-found">
            <h2>Товар не найден</h2>
            <p>Извините, запрашиваемый товар не существует.</p>
            <button class="btn-back" @onclick="ReturnToHome">Вернуться на главную</button>
        </div>
    }
</div>

<!-- Модальное окно входа (копия с главной страницы) -->
@if (showLoginModal)
{
    <div class="modal-overlay" @onclick="CloseModal">
        <div class="modal-content" @onclick:stopPropagation>
            <div class="modal-header">
                <h3>@(isLoginMode ? "Вход в аккаунт" : "Регистрация")</h3>
                <button class="modal-close" @onclick="CloseModal">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" class="form-input" @bind="user.Email" />
                </div>
                <div class="form-group">
                    <label>Пароль</label>
                    <input type="password" class="form-input" @bind="user.Password" />
                </div>
                @if (!isLoginMode)
                {
                    <div class="form-group">
                        <label>Подтвердите пароль</label>
                        <input type="password" class="form-input" @bind="confirmPassword" />
                    </div>
                }
                <button class="auth-btn" @onclick="HandleAuth">
                    @(isLoginMode ? "Войти" : "Зарегистрироваться")
                </button>

                <div class="auth-links">
                    @if (isLoginMode)
                    {
                        <a href="#" @onclick="ToggleMode" class="auth-link">Регистрация</a>
                        <a href="#" @onclick="ShowForgotPassword" class="auth-link">Не могу войти</a>
                    }
                    else
                    {
                        <a href="#" @onclick="ToggleMode" class="auth-link">Уже есть аккаунт? Войти</a>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int ProductId { get; set; }

    private Product product;
    private bool isAuthenticated = false;
    private bool showLoginModal = false;
    private bool isLoginMode = true;
    private User user = new();
    private string confirmPassword = string.Empty;

    private List<CartItem> cartItems = new List<CartItem>();
    public List<Cart> cartList = new List<Cart>();
    private Cart currentUserCart = new();
    private UserService userService = new UserService();

    protected override async Task OnInitializedAsync()
    {
        await LoadProduct();
        await LoadCartFromStorage();
        await CheckAuthenticationStatus();
    }

    private async Task LoadProduct()
    {
        var products = await ProductService.GetProductsAsync();
        product = products.FirstOrDefault(p => p.Id == ProductId);
    }

    private async Task LoadCartFromStorage()
    {
        try
        {
            var savedCart = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "userCart");
            if (!string.IsNullOrEmpty(savedCart))
            {
                cartItems = System.Text.Json.JsonSerializer.Deserialize<List<CartItem>>(savedCart) ?? new List<CartItem>();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка загрузки корзины: {ex.Message}");
            cartItems = new List<CartItem>();
        }
    }

    private async Task CheckAuthenticationStatus()
    {
        try
        {
            var savedEmail = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "userEmail");
            if (!string.IsNullOrEmpty(savedEmail))
            {
                isAuthenticated = true;
                userService.currentUser = userService.userList.FirstOrDefault(u => u.Email == savedEmail) ?? new User();
                currentUserCart = cartList.FirstOrDefault(c => c.user_id == userService.currentUser.id) ?? new Cart();
            }
        }
        catch
        {
            isAuthenticated = false;
        }
    }

    private async Task AddToCart(int productId)
    {
        if (!isAuthenticated)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Для добавления в корзину необходимо войти в систему");
            ShowLoginModal();
            return;
        }

        var existingItem = cartItems.FirstOrDefault(ci => ci.product_id == productId);
        if (existingItem != null)
        {
            existingItem.quantity++;
        }
        else
        {
            var newCartItem = new CartItem
                {
                    cart_id = currentUserCart.cart_id,
                    product_id = productId,
                    quantity = 1
                };
            cartItems.Add(newCartItem);
        }

        await SaveCartToStorage();
        await JSRuntime.InvokeVoidAsync("alert", "Товар добавлен в корзину");
        StateHasChanged();
    }

    private async Task BuyNow(int productId)
    {
        if (!isAuthenticated)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Для покупки необходимо войти в систему");
            ShowLoginModal();
            return;
        }

        var tempCartItems = new List<CartItem>
        {
            new CartItem
            {
                cart_id = currentUserCart.cart_id,
                product_id = productId,
                quantity = 1
            }
        };

        var cartJson = System.Text.Json.JsonSerializer.Serialize(tempCartItems);
        await JSRuntime.InvokeVoidAsync("localStorage.setItem", "buyNowCart", cartJson);
        NavigationManager.NavigateTo("/checkout");
    }

    private bool IsProductInCart(int productId)
    {
        if (!isAuthenticated) return false;
        return cartItems.Any(ci => ci.product_id == productId);
    }

    private int GetCartItemsCount()
    {
        if (!isAuthenticated) return 0;
        return cartItems.Sum(ci => ci.quantity);
    }

    private async Task SaveCartToStorage()
    {
        try
        {
            var cartJson = System.Text.Json.JsonSerializer.Serialize(cartItems);
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "userCart", cartJson);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка сохранения корзины: {ex.Message}");
        }
    }

    private void ShowLoginModal()
    {
        if (!isAuthenticated)
        {
            showLoginModal = true;
            isLoginMode = true;
            user = new User();
            confirmPassword = string.Empty;
            StateHasChanged();
        }
    }

    private void CloseModal()
    {
        showLoginModal = false;
        user = new User();
        confirmPassword = string.Empty;
        StateHasChanged();
    }

    private void ToggleMode()
    {
        isLoginMode = !isLoginMode;
        user = new User();
        confirmPassword = string.Empty;
        StateHasChanged();
    }

    private async Task HandleAuth()
    {
        if (string.IsNullOrEmpty(user.Email) || string.IsNullOrEmpty(user.Password))
        {
            await JSRuntime.InvokeVoidAsync("alert", "Заполните все поля");
            return;
        }

        if (!isLoginMode && user.Password != confirmPassword)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Пароли не совпадают");
            return;
        }

        if (isLoginMode)
        {
            // Логика входа
            var existingUser = userService.userList.FirstOrDefault(u => u.Email == user.Email && u.Password == user.Password);
            if (existingUser != null)
            {
                isAuthenticated = true;
                userService.currentUser = existingUser;
                currentUserCart = cartList.FirstOrDefault(c => c.user_id == userService.currentUser.id) ?? new Cart();
                await JSRuntime.InvokeVoidAsync("localStorage.setItem", "userEmail", user.Email);
                await JSRuntime.InvokeVoidAsync("alert", $"Вход выполнен: {user.Email}");
                CloseModal();
                StateHasChanged();
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", "Неверный email или пароль");
            }
        }
        else
        {
            // Логика регистрации
            if (userService.userList.Any(u => u.Email == user.Email))
            {
                await JSRuntime.InvokeVoidAsync("alert", "Пользователь с таким email уже существует");
                return;
            }

            int maxUserId = userService.userList.Count > 0 ? userService.userList.Max(u => u.id) + 1 : 1;
            int maxCartId = cartList.Count > 0 ? cartList.Max(c => c.cart_id) + 1 : 1;

            // Создаем корзину для нового пользователя
            Cart newCart = new Cart { cart_id = maxCartId, user_id = maxUserId };
            cartList.Add(newCart);

            // Создаем пользователя
            User newUser = new User
                {
                    id = maxUserId,
                    Email = user.Email,
                    Password = user.Password
                };
            userService.userList.Add(newUser);

            isAuthenticated = true;
            userService.currentUser = newUser;
            currentUserCart = newCart;
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "userEmail", user.Email);
            await JSRuntime.InvokeVoidAsync("alert", $"Регистрация выполнена: {user.Email}");
            CloseModal();
            StateHasChanged();
        }
    }

    private void ShowForgotPassword()
    {
        Console.WriteLine("Восстановление пароля");
    }

    private void ReturnToHome()
    {
        NavigationManager.NavigateTo("/");
    }
}